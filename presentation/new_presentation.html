<!DOCTYPE html>
<html>
  <head>
    <title>creating reproducible sum calibrations for archaeological demographic assessments</title>
    <meta charset="utf-8">
    <meta name="author" content="Grunert, Nicole - Hinz, Martin - Schmid, Clemens" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="isaak-theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# creating reproducible sum calibrations for archaeological demographic assessments
## the R package oxcAAR
### Grunert, Nicole - Hinz, Martin - Schmid, Clemens
### 2016/12/12 (updated: 2018-08-30)

---

# Outline

- Reproducible Research
- Reproducible Research for 'sum calibration demography'
- Features of oxCAAR
- Doing sum calibration research with oxCAAR

---
class: inverse, bottom
# Reproducible Research

---

## what is Reproducible Research

![Peng 2011, Science 334(6060) pp. 1226-1227](../images/F1.large.jpg)
.caption.pull-right[Peng 2011, Science 334(6060) pp. 1226-1227]

&gt; 'The goal of reproducible research is to tie specific instructions to data analysis and experimental data so that scholarship can be recreated, better understood and verified.' - Max Kuhn, CRAN Task View: Reproducible Research


---
## what is Reproducible Research cont.

&lt;center&gt;
&lt;img src="../images/journal.pbio.1002506.g001.PNG" style="width: 33%;"/&gt;
&lt;/center&gt;
.caption.pull-right[Gorgolewski &amp; Poldrack 2016]

&gt; 'An article about computational science in a scientic publication is not the scholarship itself, it is merely advertising of the scholarship. The actual scholarship is the complete software development environment and the complete set of instructions which generated the figures.' - Buckheit and Donoho 1995

---

## why Reproducible Research

| Scientific Principles | traditional research | reproducible archaeological research |
|------------------------------------|---------------------------|--------------------------------------|
| Empirically Testable (observation) | ususally NA | x |
| Replicability | ususally NA | x |
| Objective | ? | ? |
| Transparency | partly | x |
| Falsifiable | ususally anecdotally only | x |
| Logically consistent | hopefully | controllable |

---
background-image: url(../images/duffy.gif)
background-position: 50% 80%

## why also Reproducible Research

- why every time reinvent the wheel?
  - waste of tax money
  - constant frustration!
  - why should knowledge die with the scientist?

---
class: inverse, bottom
# Reproducible Research for 'sum calibration demography'

---
## why Reproducible Research for 'sum calibration demography'

- it's not the world's most uncontroversial method
- point-and-click working with OxCal does not increase credibility of the results

---
### you might say

&gt; but OxCal includes a scripting language which can be used for reproducibility!

&lt;pre&gt;
Sequence("my_sequence"){
  Boundary("begin");
  Phase("first"){
    R_Date("ABC-123", 5020, 20);
    R_Date("ABC-321", 5200, 20);};
  Boundary("between");
  Phase("second"){
  R_Date("CBA-123", 5010, 20);
  R_Date("CBA-321", 4810, 20);};
  Boundary("end");
};
&lt;/pre&gt;

---
## why Reproducible Research for 'sum calibration demography'

- it's not the world's most uncontroversial method
- point-and-click working with OxCal does not increase credibility of the results
- validation requires simulations

---
### 'eyeballing' simulation

&lt;div class="pull-left"&gt;
&lt;img src="../images/bamforth_grund_fig1.png" style="width: 50%;"/&gt;
&lt;br/&gt;
.caption[Bamforth &amp; Grund 2012]
&lt;/div&gt;
&lt;div class="pull-right"&gt;
&lt;img src="../images/bg_resim.png" style="width: 100%;"/&gt;
&lt;br/&gt;
.caption[resimulation with the same parameters, mean of 100 iterations]
&lt;/div&gt;
&lt;hr  style="clear:both;"/&gt;

Bamforth &amp; Grund 2012: Using two arbitrary simulated results for assuming correlation between 14C sum calibration and shape of the cal curve

---
## why Reproducible Research for 'sum calibration demography'

- it's not the world's most uncontroversial method
- point-and-click working with OxCal does not increase credibility of the results
- validation requires simulations
  - simulation requires repetition

---
### the 'ucl approach'

&gt; We fitted an exponential GLM with a quasi-Poisson distributed error to a SCDPD constructed from all 14C dates from the entire study area, using the wider date range of 4,000–10,000 cal. BP (Fig. 2, Supplementary Table S1). Simulated SCDPDs (50,000) for each demographic region were generated by sampling n calendar dates from under the fitted GLM where n is the number of site phases in each region, and then converting to n14C dates by sampling from the calibration curve error at the corresponding calendar date. The simulated 14C dates were rounded using a Monte Carlo method to give the same proportion of different date roundings as that used by 14C laboratories, assigned errors by sampling with replacement from observed 14C data errors, and then calibrated using the same procedure as for the observed data. Finally, the simulated calibrated date probability distributions were summed and normalized to unity. - Shennan et al. 2013

---
### the 'ucl approach', for a lot of colleagues

&gt; Chúng tôi trang bị GLM theo cấp số nhân với sai số phân bố quasi-Poisson cho SCDPD được xây dựng từ tất cả các ngày 14C từ toàn bộ khu vực nghiên cứu, sử dụng phạm vi ngày rộng hơn từ 4.000-10.000 cal. BP (Hình 2, Bảng bổ sung S1). Mô phỏng SCDPDs (50.000) cho mỗi khu vực nhân khẩu học được tạo ra bằng cách lấy mẫu n ngày tháng theo GLM được trang bị trong đó n là số pha của từng khu vực, sau đó chuyển thành ngày n14C bằng cách lấy mẫu từ sai số đường chuẩn tại lịch tương ứng ngày. Các ngày 14C mô phỏng được làm tròn bằng phương pháp Monte Carlo để cung cấp cùng tỷ lệ các vòng ngày khác nhau như được sử dụng bởi các phòng thí nghiệm 14C, được gán lỗi bằng cách lấy mẫu thay thế từ các lỗi dữ liệu 14C quan sát được, và hiệu chuẩn bằng cách sử dụng quy trình tương tự như dữ liệu. Cuối cùng, các bản phân phối xác suất ngày được hiệu chỉnh mô phỏng được tổng hợp và chuẩn hóa thành sự thống nhất. - Shennan et al. 2013

---
background-image: url(../images/316px-Dr._Robert_Goddard_at_Clark_University_-_GPN-2002-000130.jpg)
background-size: cover
class: inverse, bottom

### Rocket Science!

---
## why Reproducible Research for 'sum calibration demography'

- it's not the world's most uncontroversial method
- point-and-click working with OxCal does not increase credibility of the results
- validation requires simulations
  - simulation requires repetition
  - when it comes to more complicated scripting, the actual script is beneficial for reproduction
- eg. 'R' +1

---
### Several possibilities for calibration

#### outside of R
* CalPal, BCal, CALIB, Fairbanks calibration, OxCal, iosacal, MatCal
* [calibrator](https://github.com/ISAAKiel/calibrator)
* ChronoModel

#### within R
* [Bchron](http://cran.rstudio.com/web/packages/Bchron/index.html)
  * ![Andrew Parnell](../images/parnell.jpeg) Andrew Parnell
* [rcarbon](https://cran.r-project.org/web/packages/rcarbon/index.html)
  * ![Andrew Bevan](../images/bevan.jpeg) Andrew Bevan
* [oxcAAR](https://cran.r-project.org/web/packages/oxcAAR/index.html)
  * ![ISAAK](../images/isaak.png) ISAAK

---
### Why another calibration package?

*1. Every package produces slightly different results*

&lt;img src="../images/comp_results_packages-1.png" style="width: 50%" class="pull-left"&gt;

&lt;img src="../images/comp_results_packages_detail-1.png" style="width: 50%" class="pull-right"&gt;

*2. Sequential Calibration with other tools (currently) not available*

&lt;img src="../images/make_string_for_sequence_calibration-1.png" style="width: 33%"&gt;

---
## why Reproducible Research for 'sum calibration demography'

- it's not the world's most uncontroversial method
- point-and-click working with OxCal does not increase credibility of the results
- validation requires simulations
  - simulation requires repetition
  - when it comes to more complicated scripting, the actual script is beneficial for reproduction
- eg. 'R' +1
- Sometimes it might be more 'reproducible' if you accept general standard software
  - in the long run actually you should change the standard, if it is opaque ...

---
class: inverse, bottom
# Features of oxCAAR

---
## Idea

 oxcAAR is a R package to **calibrate**, **simulate** and **sum** &lt;sup&gt;14&lt;/sup&gt;C dates using **OxCal** as calibration engine




```r
quickSetupOxcal() # download Oxcal to tempory folder
```

```
## NULL
```

```r
oxcalCalibrate( bp=5000, std=20) # do the calibration
```

```
## 
## =============================
## 	R_Date: 1
## =============================
## 
## 
## BP = 5000, std = 20
## 
## 
## unmodelled:                    
## 
## one sigma                      
## 3794 BC - 3759 BC (43.8%)      
## 3740 BC - 3712 BC (24.4%)      
## 
## two sigma                      
## 3910 BC - 3876 BC (12.1%)      
## 3802 BC - 3706 BC (83.3%)      
## 
## three sigma                    
## 3939 BC - 3858 BC (15.5%)      
## 3813 BC - 3698 BC (84.2%)      
## 
## Calibrated with:
## 	  IntCal13 atmospheric curve (Reimer et al 2013)
```

---
## Accessing the calibration result - structure


```r
my_cal_date &lt;- oxcalCalibrate( bp=5000, std=20)
str(my_cal_date, max.level = 3)
```

```
## List of 1
##  $ 1:List of 9
##   ..$ name                   : chr "1"
##   ..$ type                   : chr "R_Date"
##   ..$ bp                     : int 5000
##   ..$ std                    : int 20
##   ..$ cal_curve              :List of 5
##   .. ..$ name      : chr " IntCal13 atmospheric curve (Reimer et al 2013)"
##   .. ..$ resolution: num 5
##   .. ..$ bp        : num [1:10001] 46401 46396 46391 46386 46381 ...
##   .. ..$ bc        : num [1:10001] -48050 -48044 -48040 -48034 -48030 ...
##   .. ..$ sigma     : num [1:10001] 274 274 274 273 273 ...
##   ..$ sigma_ranges           :List of 3
##   .. ..$ one_sigma  :'data.frame':	2 obs. of  3 variables:
##   .. ..$ two_sigma  :'data.frame':	2 obs. of  3 variables:
##   .. ..$ three_sigma:'data.frame':	2 obs. of  3 variables:
##   ..$ raw_probabilities      :'data.frame':	67 obs. of  2 variables:
##   .. ..$ dates        : num [1:67] -3970 -3964 -3960 -3954 -3950 ...
##   .. ..$ probabilities: num [1:67] 0.00 0.00 0.00 1.43e-07 1.94e-06 ...
##   ..$ posterior_sigma_ranges :List of 3
##   .. ..$ one_sigma  : logi NA
##   .. ..$ two_sigma  : logi NA
##   .. ..$ three_sigma: logi NA
##   ..$ posterior_probabilities: logi NA
##   ..- attr(*, "class")= chr "oxcAARCalibratedDate"
##  - attr(*, "class")= chr [1:2] "list" "oxcAARCalibratedDatesList"
```

---
## Accessing the calibration result - for basic plot


```r
plot(
  my_cal_date$`1`$raw_probabilities$dates,
  my_cal_date$`1`$raw_probabilities$probabilities,
  type = "l", xlab = "years", ylab = "probs"
)
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-4-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
## Features - plotting an individual date

Plotting an individual date


```r
oxcalCalibrate( bp=5000, std=20) %&gt;% plot()
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-5-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
## Features - plotting multiple dates


```r
oxcalCalibrate( bp=c(5000,5200), std=c(20,25)) %&gt;% plot()
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-6-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
## Features - plotting on the calibration curve


```r
oxcalCalibrate( bp=c(5000,5200), std=c(20,25)) %&gt;% calcurve_plot()
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-7-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
class: inverse, bottom
# Simulation

---
## Features - simulating a R_Date


```r
oxcalSimulate(-3400, 25, "SimDate_1") %&gt;% plot()
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-8-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
## Features - simulating a sum calibration


```r
oxcalSumSim(
  timeframe_begin = -4000, # From when
  timeframe_end = -3000, # To when
  n = 50, # Number of dates
  stds = 35, # Standard deviation of dates (can also be a vector of length n)
  date_distribution = "uniform" # random uniform; alternatively: equidist for equidistant dates
) %&gt;% plot()
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-9-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
### A sample (simulated) Dataset:




```r
my_result_data &lt;- R_Date(names = my_bp_dates$names,
                         r_dates = my_bp_dates$bp,
                         std = my_bp_dates$std) %&gt;% oxcal_Sum() %&gt;%
  executeOxcalScript() %&gt;%
  readOxcalOutput() %&gt;%
  parseOxcalOutput(only.R_Date = FALSE, first = TRUE)

plot(my_result_data)
```

&lt;img src="new_presentation_files/figure-html/unnamed-chunk-11-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---
### Simulating a random envelope
.pull-left[

```r
sim_result &lt;- my_bp_dates %&gt;%
  broom::bootstrap(2) %&gt;%
  do(
    oxcalSumSim(
      n = nrow(my_bp_dates),
      stds = sample(my_bp_dates$std),
      timeframe_begin = -4000,
      timeframe_end = -1000,
      date_distribution = "uniform"
    )$raw_probabilities
  )

alpha = .05

envelope &lt;- sim_result %&gt;%
  group_by(dates) %&gt;%
  summarize(
    low=quantile(probabilities, alpha / 2),
    high=quantile(probabilities, 1 - alpha / 2)
  )

# my_raw_probabilities &lt;-
# my_result_data$` Sum `$raw_probabilities
#
# ggplot() +
#   geom_ribbon(data = envelope,
#               aes(x=dates,
#                   ymin=low,
#                   ymax = high),
#               alpha = .3) + 
#   geom_line(data = my_raw_probabilities,
#             aes(x=dates,
#                 y=probabilities),
#             color="red")
```
]

.pull-right[
&lt;img src="new_presentation_files/figure-html/unnamed-chunk-13-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---
class: inverse, bottom
# Summary

---
background-image: url(../images/logos/isaak_with_text.png)
background-position: bottom right
## oxCAAR as tool for reproducible 14C based research

* brings together the standard calibration tool and a mighty analytical environment
* adds the possibility to easy script simulations
* makes code exchange and discussion of methods and results very easy

https://cran.r-project.org/web/packages/oxcAAR/index.html

https://github.com/ISAAKiel/oxcAAR

&lt;br&gt;
&lt;br&gt;
&lt;br&gt;

.pull-left[### Thats all, folks!]
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script>
(function() {
  var i, text, code, codes = document.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
})();
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
